## Хранимые процедуры в SQL

Хранимые процедуры — это программные блоки, которые выполняют определённую последовательность действий в базе данных.

В отличие от функций, процедуры могут изменять данные, выполнять сложную бизнес-логику, но не могут возвращать значения.

## Общая структура хранимой процедуры

```sql
CREATE OR REPLACE PROCEDURE имя_процедуры(параметр1 ТИП, параметр2 ТИП, ...)
LANGUAGE plpgsql
AS $$
BEGIN
    -- логика процедуры
END;
$$;
```

Ключевые элементы:
- `LANGUAGE plpgsql` — указывает, что процедура написана на языке PL/pgSQL (процедурном языке PostgreSQL)
- `AS $$ ... $$` — долларовое квотирование, специальный способ обрамления тела процедуры. Позволяет избежать экранирования символов внутри процедуры

## Простой пример процедуры

Процедура для обновления информации о студенте:

```sql
CREATE OR REPLACE PROCEDURE update_student_info(
    student_id INT,
    new_first_name VARCHAR(50),
    new_last_name VARCHAR(50)
)
LANGUAGE plpgsql
AS $$
BEGIN
    UPDATE Student
    SET first_name = new_first_name,
        last_name = new_last_name
    WHERE id = student_id;
END;
$$;
```

Вызов процедуры:

```sql
CALL update_student_info(1, 'Alexander', 'Smirnov');
```

Проверка результата:

```sql
SELECT * FROM Student WHERE id = 1;
```

## Отличия от функций

Хранимые процедуры:
- Не возвращают значения
- Вызываются через `CALL`
- Могут выполнять сложную бизнес-логику
- Идеальны для изменения данных в нескольких таблицах

Хранимые функции:
- Всегда возвращают одно значение
- Можно использовать в `SELECT`, `WHERE` и других частях запроса
- Идеальны для вычислений и преобразований данных

## Управление хранимыми процедурами

Просмотр существующих процедур:

```sql
SELECT routine_name, routine_type
FROM information_schema.routines
WHERE routine_type = 'PROCEDURE' AND routine_schema = 'public';
```

Удаление процедуры:

```sql
DROP PROCEDURE IF EXISTS add_student(VARCHAR, VARCHAR, DATE);
```

Изменение процедуры:

```sql
CREATE OR REPLACE PROCEDURE add_student(
    student_first_name VARCHAR(50),
    student_last_name VARCHAR(50),
    student_birthday DATE
)
LANGUAGE plpgsql
AS $$
BEGIN
    -- новая реализация
END;
$$;
```

## Преимущества хранимых процедур

- Централизация бизнес-логики
- Повышение производительности
- Гарантия целостности данных
- Упрощение сложных операций
- Возможность выполнения последовательности действий как единого целого
