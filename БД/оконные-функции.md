## Оконные функции SQL

Оконные функции — мощный инструмент языка SQL, позволяющий проводить сложные вычисления по группам строк, которые связаны с текущей строкой.

## Принцип работы

В стандартном SQL-запросе все наборы строк рассматриваются как один сплошной блок данных, для которого и вычисляются агрегатные значения.

Когда применяются оконные функции, запрос сегментируется на группы строк (или «окна»), и для каждого такого сегмента подсчитываются индивидуальные агрегатные значения.

Окно, которое подаётся в оконную функцию, может быть:
- всей таблицей
- отдельными партициями таблицы, то есть группой строк на основе одного или нескольких полей
- конкретным диапазоном строк в пределах таблицы или партиции

Окно может «скользить» по таблице, динамически меняя набор данных от строки к строке.

## Синтаксис оконной функции

```sql
SELECT <оконная_функция>(<поле_таблицы>)
OVER (
      [PARTITION BY <столбцы_для_разделения>]
      [ORDER BY <столбцы_для_сортировки>]
      [ROWS|RANGE <определение_диапазона_строк>]
)
```
Общая структура оконной функции

Компоненты синтаксиса:

<оконная_функция>(<поле_таблицы>):
- Используемая оконная функция, например AVG(price)

OVER:
- Определяет окно (группу строк), которое будет передаваться в оконную функцию
- Если оставить OVER() без параметров, то окном будет выступать вся таблица

PARTITION BY <столбцы_для_разделения>:
- Выборка делится на непересекающиеся подмножества
- Каждое подмножество содержит строки с одинаковыми значениями в одном или нескольких столбцах
- Образуются партиции

ORDER BY <столбцы_для_сортировки>:
- Устанавливается порядок строк внутри окна
- Особо важную роль играет в оконных функциях ранжирования

ROWS|RANGE <определение_диапазона_строк>:
- Формируются диапазоны строк
- Можно указать, сколько строк брать до и после текущей в окно

## Пример использования оконной функции

Получение списка имён студентов и количества учащихся в их классе:

```sql
SELECT
    Student.first_name,
    Student.last_name,
    Student_in_class.class,
    COUNT(*) OVER (PARTITION BY Student_in_class.class) AS student_count_in_class
FROM
    Student_in_class
JOIN
    Student ON Student_in_class.student = Student.id;
```
Для каждого студента выводится количество учащихся в его классе

Что делает оконная функция:
- PARTITION BY Student_in_class.class разделяет все строки таблицы на партиции по полю class
- Для каждой строки в оконную функцию подаются только те строки, где поле class совпадает с полем class в текущей строке
- COUNT возвращает количество переданных в неё строк

## Порядок выполнения оконных функций в SELECT

Оконные функции выполняются предпоследним шагом:

1. FROM — выбор таблицы
2. WHERE — фильтрация записей
3. GROUP BY — группировка
4. HAVING — фильтрация групп
5. SELECT — выбор полей
6. Оконные функции — вычисления по окнам
7. ORDER BY — сортировка

Окна отрабатывают уже после фильтрации и группировки, но перед финальной сортировкой результатов выборки.

## Отличие оконных функций от агрегатных функций с группировкой

Оконные функции:
- Вычисляются для каждой строки независимо
- Возвращают результат в отдельный столбец
- Не сокращают количество строк в результате

Агрегатные функции с группировкой:
- Группируют строки и применяются к сформированным группам
- Сокращают количество строк в результате до количества групп
- Возвращают одно значение на группу

Оконные функции позволяют сохранить все строки таблицы и при этом провести агрегатные вычисления по группам.
