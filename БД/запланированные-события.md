## Запланированные события (Events)

В реальных приложениях часто возникает необходимость выполнять определённые действия автоматически и по расписанию: очищать старые записи, обновлять статистику, формировать отчёты.

Событие — это задача, которую база данных запускает сама по расписанию.

В PostgreSQL для автоматического выполнения задач используется расширение `pg_cron`. Это расширение позволяет планировать SQL-команды с использованием синтаксиса cron (как в Unix-системах).

## Когда использовать

Запланированные события помогают автоматизировать следующие задачи:

- Очистка данных: удаление устаревших записей логов или временных данных
- Обновление статистики: пересчёт агрегированных данных для аналитики
- Генерация отчётов: автоматическое формирование периодических отчётов
- Резервное копирование: создание копий важных данных

## Включение планировщика

Для использования запланированных задач нужно установить расширение `pg_cron`:

```sql
CREATE EXTENSION IF NOT EXISTS pg_cron;
```

Важно: Расширение `pg_cron` может требовать прав суперпользователя и дополнительной настройки PostgreSQL. В облачных сервисах (AWS RDS, Azure) оно может быть уже предустановлено.

## Создание одноразового события

Событие, которое выполняется регулярно по расписанию:

```sql
SELECT cron.schedule(
    'cleanup_old_logs',
    '0 3 * * *',
    'DELETE FROM logs WHERE created_at < NOW() - INTERVAL ''30 days'''
);
```

Это событие будет выполняться каждый день в 3:00 утра и удалять записи логов старше 30 дней.

Синтаксис:
- `cron.schedule()` — функция для создания запланированной задачи
- `'cleanup_old_logs'` — имя задачи
- `'0 3 * * *'` — расписание в формате cron (минута час день месяц день_недели)
- Последний параметр — SQL-команда для выполнения

## Формат cron расписания

Формат: `минута час день_месяца месяц день_недели`

```
* * * * *
│ │ │ │ │
│ │ │ │ └─── День недели (0-7, где 0 и 7 = воскресенье)
│ │ │ └───── Месяц (1-12)
│ │ └─────── День месяца (1-31)
│ └───────── Час (0-23)
└─────────── Минута (0-59)
```

## Создание повторяющегося события

Событие, запускаемое периодически:

```sql
SELECT cron.schedule(
    'update_statistics_hourly',
    '0 * * * *',
    $$
    UPDATE product_stats SET
        total_sales = (SELECT SUM(amount) FROM orders WHERE product_id = product_stats.product_id),
        last_updated = NOW()
    $$
);
```

Это событие будет обновлять статистику продаж каждый час (в начале каждого часа).

Примеры расписаний:
- `'*/5 * * * *'` — каждые 5 минут
- `'0 * * * *'` — каждый час (в начале часа)
- `'0 0 * * *'` — каждый день в полночь
- `'0 0 * * 0'` — каждое воскресенье в полночь
- `'0 9 1 * *'` — первого числа каждого месяца в 9:00

## Событие с ограниченным сроком действия

Включение проверки даты в саму команду:

```sql
SELECT cron.schedule(
    'seasonal_discount',
    '0 0 * * *',
    $$
    UPDATE products
    SET price = price * 0.9
    WHERE category = 'seasonal'
      AND CURRENT_DATE BETWEEN '2025-12-01' AND '2025-12-31'
    $$
);
```

Создание задачи на удаление события в конце периода:

```sql
SELECT cron.schedule(
    'remove_seasonal_discount',
    '0 0 1 1 *',
    $$SELECT cron.unschedule('seasonal_discount')$$
);
```

## Просмотр существующих событий

Просмотр всех запланированных задач:

```sql
SELECT * FROM cron.job;
```

Просмотр истории выполнения задач:

```sql
SELECT * FROM cron.job_run_details
ORDER BY start_time DESC
LIMIT 10;
```

## Управление событиями

Удаление запланированной задачи:

```sql
SELECT cron.unschedule('cleanup_old_logs');
```

Удаление по ID задачи:

```sql
SELECT cron.unschedule(42);
```

Изменение задачи:

В `pg_cron` нельзя изменить существующую задачу напрямую. Нужно удалить старую и создать новую:

```sql
SELECT cron.unschedule('cleanup_old_logs');

SELECT cron.schedule(
    'cleanup_old_logs',
    '0 */2 * * *',
    'DELETE FROM logs WHERE created_at < NOW() - INTERVAL ''30 days'''
);
```

## Важные моменты

Права доступа:
- Для использования `pg_cron` обычно требуются права суперпользователя или специальная настройка

Временная зона:
- Задачи `pg_cron` выполняются по временной зоне PostgreSQL
- Проверка: `SHOW timezone;`

Производительность:
- `pg_cron` проверяет расписание каждую секунду
- Минимальная точность — 1 минута

Логирование:
- Все выполнения задач сохраняются в таблице `cron.job_run_details`
- Полезно для отладки

## Преимущества запланированных событий

- Автоматизация рутинных задач
- Поддержка чистоты данных
- Автоматическое обновление статистики
- Выполнение регламентных операций без участия разработчиков
