## Условная логика, оператор CASE

SQL позволяет писать условную логику, чтобы в зависимости от набора условий возвращать одно из множества возможных значений. Для этого используется оператор CASE.

Условная логика — наличие у программы нескольких путей выполнения в зависимости от каких-то условий.

```sql
SELECT first_name, last_name,
CASE
  WHEN EXTRACT(YEAR FROM AGE(NOW(), birthday)) >= 18 THEN 'Совершеннолетний'
  ELSE 'Несовершеннолетний'
END AS status
FROM Student
```
Пример условной логики: определяет статус совершеннолетия студента

## Поисковое выражение CASE

```sql
CASE
    WHEN условие_1 THEN возвращаемое_значение_1
    WHEN условие_2 THEN возвращаемое_значение_2
    WHEN условие_n THEN возвращаемое_значение_n
    [ELSE возвращаемое_значение_по_умолчанию]
END
```
Синтаксис поискового выражения CASE

Если условие_1 возвращает истинное значение, то выражение CASE вернёт возвращаемое_значение_1, иначе будет сделана проверка на условие_2 и т.д. Если ни одно из предложенных условий не будет выполнено, то вернётся NULL или возвращаемое_значение_по_умолчанию, если была использована конструкция ELSE.

```sql
SELECT name,
CASE
  WHEN SUBSTRING(name, 1, POSITION(' ' IN name) - 1) IN ('10', '11') THEN 'Старшая школа'
  WHEN SUBSTRING(name, 1, POSITION(' ' IN name) - 1) IN ('5', '6', '7', '8', '9') THEN 'Средняя школа'
  ELSE 'Начальная школа'
END AS stage
FROM Class
```
Пример поискового выражения CASE: определяет этап школьного образования

Проверка выполняется последовательно сверху вниз. Как только условие становится истинным, возвращается соответствующее значение и проверка останавливается.

## Простое выражение CASE

Оператор CASE также имеет более простой синтаксис, который является менее гибким, но более читаемым для простых случаев сравнения значения с набором констант.

```sql
CASE значение
    WHEN сравниваемое_значение_1 THEN возвращаемое_значение_1
    WHEN сравниваемое_значение_2 THEN возвращаемое_значение_2
    WHEN сравниваемое_значение_n THEN возвращаемое_значение_n
    [ELSE возвращаемое_значение_по_умолчанию]
END
```
Синтаксис простого выражения CASE

В этом синтаксисе значение в CASE поочерёдно сравнивается с переданными значениями в WHEN и при совпадении возвращается значение, следующее за THEN.

```sql
SELECT name,
CASE SUBSTRING(name, 1, POSITION(' ' IN name) - 1)
  WHEN '11' THEN 'Старшая школа'
  WHEN '10' THEN 'Старшая школа'
  WHEN '9' THEN 'Средняя школа'
  WHEN '8' THEN 'Средняя школа'
  WHEN '7' THEN 'Средняя школа'
  WHEN '6' THEN 'Средняя школа'
  WHEN '5' THEN 'Средняя школа'
  ELSE 'Начальная школа'
END AS stage
FROM Class
```
Пример простого выражения CASE: тот же результат, но с более простым синтаксисом

## Разница между поисковым и простым выражением CASE

Поисковое выражение CASE:
- Проверяет условия через WHEN условие THEN
- Более гибкое, позволяет использовать сложные условия (операторы сравнения, логические операторы)
- Подходит для условий с диапазонами, сравнениями, комбинациями

Простое выражение CASE:
- Сравнивает одно значение с набором констант через WHEN значение THEN
- Более компактное и читаемое для простых случаев
- Подходит для сопоставления значения с конкретными константами

## ELSE в CASE

Конструкция ELSE является опциональной. Если ни одно условие не выполнено и ELSE отсутствует, CASE возвращает NULL.

Рекомендуется всегда использовать ELSE для обработки всех возможных случаев.

## Дополнительные функции условной логики

PostgreSQL предоставляет дополнительные функции, которые упрощают работу с условной логикой в специальных случаях. Эти функции особенно полезны при работе с NULL значениями.

Помимо универсального оператора CASE, PostgreSQL предоставляет:
- Функция COALESCE — для работы с NULL значениями
- Функция NULLIF — для специальных случаев с NULL

## Функция COALESCE

COALESCE возвращает первое не-NULL значение из списка аргументов.

```sql
COALESCE(значение1, значение2, ..., значениеN);
```
Синтаксис функции COALESCE

Это намного удобнее, чем писать длинные CASE выражения для обработки NULL.

```sql
SELECT COALESCE('SQL Academy', 'Альтернатива SQL Academy') AS sql_trainer;
```
Если первый аргумент не равен NULL, вернётся именно он

```sql
SELECT COALESCE(NULL, 'Альтернатива SQL Academy') AS sql_trainer;
```
Если первый аргумент равен NULL, вернётся следующее не-NULL значение

```sql
SELECT COALESCE(NULL, NULL, 'SQL Academy', 'Запасной вариант') AS sql_trainer;
```
COALESCE может принимать множество аргументов

Сравнение с CASE:

```sql
CASE
    WHEN значение1 IS NOT NULL THEN значение1
    WHEN значение2 IS NOT NULL THEN значение2
    ELSE значение3
END
```
Эквивалентно COALESCE(значение1, значение2, значение3), но COALESCE намного проще

## Функция NULLIF

NULLIF полезна, когда нужно заменить определённое значение на NULL. Это может пригодиться для фильтрации или обработки "пустых" значений.

```sql
NULLIF(значение_1, значение_2);
```
Синтаксис функции NULLIF

Функция NULLIF возвращает NULL, если значение_1 равно значение_2, в противном случае возвращает значение_1.

```sql
SELECT NULLIF('SQL Academy', 'SQL Academy') AS sql_trainer;
```
Если значения равны, возвращается NULL

```sql
SELECT NULLIF('SQL Academy', 'Альтернатива SQL Academy') AS sql_trainer;
```
Если значения различаются, возвращается значение первого аргумента

## Когда использовать каждую функцию

CASE:
- Когда нужна сложная условная логика с множественными условиями
- Подходит для условий с диапазонами, сравнениями, комбинациями

COALESCE:
- Когда нужно заменить NULL значения на значения по умолчанию
- Упрощает обработку NULL в запросах
- Делает код более читаемым для работы с NULL

NULLIF:
- Когда нужно превратить определённые значения в NULL
- Полезно для фильтрации или обработки "пустых" значений

Эти функции являются частью стандарта SQL и делают код более читаемым в определённых ситуациях.
