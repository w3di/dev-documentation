## Хранимые функции в SQL

Хранимые функции — это мощный инструмент SQL, который позволяет создавать переиспользуемые блоки кода для выполнения вычислений и преобразования данных.

Хранимая функция — это именованный блок SQL-кода, который принимает параметры, выполняет вычисления и всегда возвращает одно значение определённого типа.

## Общая структура хранимой функции

```sql
CREATE OR REPLACE FUNCTION имя_функции(параметр1 ТИП, параметр2 ТИП, ...)
RETURNS тип_возвращаемого_значения
LANGUAGE plpgsql
AS $$
BEGIN
    -- логика функции
    RETURN результат_вычислений;
END;
$$;
```

Ключевые элементы:
- `LANGUAGE plpgsql` — указывает, что функция написана на языке PL/pgSQL (процедурном языке PostgreSQL)
- `AS $$ ... $$` — долларовое квотирование, специальный способ обрамления тела функции. Позволяет избежать экранирования символов внутри функции
- `RETURNS` — указывает тип возвращаемого значения

## Простой пример функции

Функция для определения, является ли человек совершеннолетним по дате рождения:

```sql
CREATE OR REPLACE FUNCTION is_adult(birth_date DATE)
RETURNS BOOLEAN
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN EXTRACT(YEAR FROM AGE(CURRENT_DATE, birth_date)) >= 18;
END;
$$;
```

Использование функции:

```sql
SELECT
    is_adult('2010-05-15') AS child_status,
    is_adult('2000-03-20') AS adult_status;
```

## Использование функций в запросах к таблицам

Функции можно использовать для фильтрации и преобразования данных:

```sql
SELECT
    first_name,
    last_name,
    birthday,
    is_adult(birthday) AS is_adult
FROM Student
WHERE is_adult(birthday) = TRUE
LIMIT 5;
```

## Функции с запросами к базе данных

Хранимые функции могут выполнять SQL-запросы внутри себя для получения необходимых данных:

```sql
CREATE OR REPLACE FUNCTION get_student_lessons_count(student_id INT, target_date DATE)
RETURNS INT
LANGUAGE plpgsql
AS $$
DECLARE
    lessons_count INT;
BEGIN
    SELECT COUNT(*) INTO lessons_count
    FROM Schedule s
    INNER JOIN Student_in_class sic ON s.class = sic.class
    WHERE sic.student = student_id
      AND s.date = target_date;

    RETURN lessons_count;
END;
$$;
```

Использование:

```sql
SELECT get_student_lessons_count(1, '2019-09-01') AS lessons_today;
```

## Работа с переменными

Все переменные должны быть объявлены в блоке `DECLARE` до начала тела функции (до `BEGIN`).

Объявление переменной:

```sql
DECLARE lessons_count INT;
```

Сохранение результата запроса в переменную:

```sql
SELECT COUNT(*) INTO lessons_count
FROM Schedule s
WHERE s.date = target_date;
```

Ключевые моменты:
- `SELECT ... INTO` — сохраняет результат запроса в переменную
- Переменные объявляются в блоке `DECLARE`
- Объявлять переменные внутри тела функции нельзя

## Управление хранимыми функциями

Просмотр существующих функций:

```sql
SELECT routine_name, routine_type
FROM information_schema.routines
WHERE routine_type = 'FUNCTION' AND routine_schema = 'public';
```

Удаление функции:

```sql
DROP FUNCTION IF EXISTS is_adult(DATE);
```

Изменение функции:

```sql
CREATE OR REPLACE FUNCTION is_adult(birth_date DATE)
RETURNS BOOLEAN
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN EXTRACT(YEAR FROM AGE(CURRENT_DATE, birth_date)) >= 18;
END;
$$;
```

## Преимущества хранимых функций

- Переиспользуемость кода
- Централизация бизнес-логики
- Возможность использования в любых SQL-запросах
- Консистентность вычислений во всём приложении
