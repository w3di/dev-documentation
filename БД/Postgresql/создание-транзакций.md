## Создание транзакций

Транзакция обеспечивает защиту от ошибок, гарантируя, что либо все операции выполнятся успешно, либо ни одна из них не будет применена.

Например, при переводе денег с одного счёта на другой транзакция гарантирует, что деньги либо останутся на исходном счёте, либо будут переведены на другой счёт, исключая риск их утраты.

## Запуск и завершение транзакций

Каждая явная транзакция в PostgreSQL начинается с использования оператора `BEGIN` или `START TRANSACTION`.

Завершение транзакции возможно:

Команда `COMMIT`:
- Даёт указание серверу пометить изменения как постоянные
- Освобождает все ресурсы (блокировки строк), использовавшиеся во время транзакции

Команда `ROLLBACK`:
- Требует от сервера вернуть данные в состояние до начала транзакции
- Освобождает любые ресурсы, используемые транзакцией

## Пример транзакции

```sql
BEGIN;

UPDATE accounts
SET user_balance = user_balance - 1000
WHERE user_id = 1
  AND user_balance >= 1000;

UPDATE accounts
SET user_balance = user_balance + 1000
WHERE user_id = 2;

COMMIT;
```

Если возникнут какие-либо проблемы, будет выполнена команда `ROLLBACK`, которая указывает серверу отменить все действия, совершённые с начала транзакции.

## Внешние факторы завершения транзакции

Помимо использования команд `COMMIT` и `ROLLBACK`, транзакция также может завершиться в результате внешних факторов.

Например, если сервер выключается, в этом случае транзакция будет автоматически отменена при перезапуске сервера.

## Точки сохранения транзакции

Точки сохранения позволяют откатиться к конкретной точке в транзакции, а не к её началу.

Каждой точке сохранения необходимо присвоить уникальное имя, что позволит использовать множество разных точек сохранения.

Создание точки сохранения:

```sql
SAVEPOINT my_savepoint;
```

Откат к точке сохранения:

```sql
ROLLBACK TO SAVEPOINT my_savepoint;
```

## Пример использования точек сохранения

```sql
BEGIN;

SAVEPOINT before_updating_user_1;
UPDATE accounts SET balance = balance + 100 WHERE user_id = 1;

ROLLBACK TO SAVEPOINT before_updating_user_1;

UPDATE accounts SET balance = balance + 200 WHERE user_id = 2;

COMMIT;
```

В результате этой транзакции баланс первого пользователя останется без изменений из-за отката к точке сохранения, а баланс второго пользователя увеличится на 200.

## Важные моменты

При использовании точек сохранения помните:

- При создании точки сохранения ничего не сохраняется. Чтобы изменения стали постоянными, необходимо выполнить команду `COMMIT`
- При выполнении отката транзакции без указания конкретной точки сохранения все ранее установленные точки сохранения будут проигнорированы, и будет произведён откат всей транзакции
