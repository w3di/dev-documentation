## Группировка, оператор GROUP BY

GROUP BY объединяет записи в группы по указанным полям для работы с группами вместо отдельных записей.

```sql
SELECT [литералы, агрегатные_функции, поля_группировки]
FROM имя_таблицы
GROUP BY поля_группировки;
```
Общая структура запроса с GROUP BY

```sql
SELECT home_type FROM Rooms
GROUP BY home_type
```
Группирует записи по типу жилья

NULL значения при группировке:
Все NULL трактуются как равные и попадают в одну группу

Что можно выводить в SELECT при использовании GROUP BY:

Литералы — фиксированные значения

```sql
SELECT home_type, 'literal' FROM Rooms
GROUP BY home_type
```
Выводит тип жилья и литерал для каждой группы

Агрегатные функции — вычисленные значения на основе набора значений группы

```sql
SELECT home_type, AVG(price) as avg_price FROM Rooms
GROUP BY home_type
```
Вычисляет среднюю цену для каждого типа жилья

Поля группировки — поля, по которым осуществлялась группировка

Группировка по нескольким полям:

При группировке по 2 и более полям группы дополнительно разбиваются на подгруппы по второму полю и т.д.

```sql
SELECT home_type, has_tv, COUNT(*) FROM Rooms
GROUP BY home_type, has_tv
```
Группирует по типу жилья и наличию телевизора

## Агрегатные функции

Агрегатная функция выполняет вычисление на наборе значений и возвращает одно значение.

```sql
SELECT [литералы, агрегатные_функции, поля_группировки]
FROM имя_таблицы
GROUP BY поля_группировки;
```
Общая структура запроса с агрегатной функцией

```sql
SELECT home_type, AVG(price) as avg_price FROM Rooms
GROUP BY home_type
```
Вычисляет среднюю цену для каждого типа жилья

Описание агрегатных функций:

- SUM(поле_таблицы) — сумма значений
- AVG(поле_таблицы) — среднее значение
- COUNT(поле_таблицы) — количество записей
- MIN(поле_таблицы) — минимальное значение
- MAX(поле_таблицы) — максимальное значение

Агрегатные функции применяются к значениям, не равным NULL. Исключение — COUNT(*).

Примеры:

```sql
SELECT home_type, COUNT(*) as amount FROM Rooms
GROUP BY home_type
ORDER BY amount DESC
```
Подсчитывает количество каждого типа жилья и сортирует по убыванию

```sql
SELECT room_id, MAX(end_date) AS last_end_date FROM Reservations
GROUP BY room_id
```
Находит самую позднюю дату выезда для каждого жилого помещения

## Оператор HAVING

HAVING фильтрует группы после группировки. WHERE фильтрует записи до группировки.

```sql
SELECT [константы, агрегатные_функции, поля_группировки]
FROM имя_таблицы
WHERE условия_на_ограничения_строк
GROUP BY поля_группировки
HAVING условие_на_ограничение_строк_после_группировки
ORDER BY условие_сортировки
```
Общая структура запроса с HAVING

Порядок выполнения SQL запроса:
1. FROM — выбор таблицы
2. WHERE — фильтрация записей
3. GROUP BY — группировка
4. HAVING — фильтрация групп
5. SELECT — выбор полей
6. ORDER BY — сортировка

WHERE работает с записями до группировки, HAVING — с группами после группировки.

```sql
SELECT home_type, AVG(price) as avg_price FROM Rooms
GROUP BY home_type
HAVING AVG(price) > 50
```
Фильтрует группы по средней цене больше 50

В PostgreSQL алиасы из SELECT недоступны в HAVING, нужно использовать полное выражение агрегатной функции.

```sql
SELECT home_type, AVG(price) as avg_price FROM Rooms
WHERE price > 50
GROUP BY home_type
```
WHERE фильтрует записи до группировки, затем вычисляется средняя цена

```sql
SELECT home_type, MIN(price) as min_price FROM Rooms
WHERE has_tv = True
GROUP BY home_type
HAVING COUNT(*) >= 5;
```
Выбирает жильё с телевизором, группирует по типу, оставляет группы с минимум 5 записями, выводит минимальную цену
