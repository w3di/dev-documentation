## Дата и время в SQL

Временные данные являются наиболее сложными в SQL из-за множества способов задания, наличия временных зон и неочевидности вычислений.

## Генерация временных данных

Временные данные можно получить одним из следующих способов:
- скопировать данные из существующего столбца с временным типом данных
- задать дату и время через строковое представление
- получить временные данные путём вызова встроенных функций, возвращающих временной тип данных

## Строковое представление временных данных

Для задания даты и времени используются следующие форматы:

Тип | Формат по умолчанию
DATE | YYYY-MM-DD
TIMESTAMP | YYYY-MM-DD hh:mm:ss
TIME | hh:mm:ss

При указании даты допускается использовать любой знак пунктуации в качестве разделителя или задавать дату без разделителя, слитно.

```sql
SELECT  CAST('2022-06-16 16:37:23' AS TIMESTAMP) AS timestamp_1,
        CAST('2014/02/22 16:37:22' AS TIMESTAMP) AS timestamp_2,
        CAST('20220616163723' AS TIMESTAMP) AS timestamp_3,
        CAST('2021-02-12' AS DATE) AS date_1,
        CAST('16:23:13' AS TIME) AS time_1
```
Примеры валидного задания временных значений через строковое представление

Для принудительного преобразования строки в дату и время используется функция CAST.

## Функции генерации дат

Если необходимо получить временные данные из строки, которая не соответствует стандартному формату, можно использовать функцию TO_DATE.

```sql
SELECT TO_DATE('November 13, 1998', 'Month DD, YYYY') AS date;
```
Парсинг даты из произвольной строки с указанием формата

Для генерации текущей даты или времени используются встроенные функции:

```sql
SELECT CURRENT_DATE, CURRENT_TIME, NOW();
```
Получение текущей даты, времени и даты со временем

В PostgreSQL это функции CURRENT_DATE, CURRENT_TIME и NOW.

## Функции извлечения временных данных

Для получения конкретной части даты используется функция EXTRACT:

- EXTRACT(YEAR FROM date) — возвращает год для указанной даты
- EXTRACT(MONTH FROM date) — возвращает числовое значение месяца года (от 1 до 12)
- EXTRACT(DAY FROM date) — возвращает порядковый номер дня в месяце (от 1 до 31)
- EXTRACT(HOUR FROM time) — возвращает значение часа (от 0 до 23)
- EXTRACT(MINUTE FROM time) — возвращает значение минут (от 0 до 59)

## Отличие TIMESTAMP от TIMESTAMPTZ

В PostgreSQL основными типами для хранения даты и времени являются TIMESTAMP (без часового пояса) и TIMESTAMPTZ (с часовым поясом).

TIMESTAMP:
- Часовой пояс не учитывается
- Отображается в таком виде, в котором дата была установлена

TIMESTAMPTZ:
- Часовой пояс учитывается
- При выборках отображается с учётом текущего часового пояса сервера БД

Диапазон обоих типов: от 4713 BC до 294276 AD.

## Часовые пояса

В качестве точки отсчёта времени используется UTC (Coordinated Universal Time). Все остальные часовые пояса описываются количеством часов сдвига от UTC.

Часовой пояс может задаваться:
- глобально для базы данных
- для конкретного пользователя
- для текущей пользовательской сессии

```sql
ALTER DATABASE mydb SET timezone = 'Europe/Moscow';
ALTER USER myuser SET timezone = 'Europe/Moscow';
SET TIME ZONE 'Europe/Moscow';
SET TIME ZONE '+03:00';
```
Примеры установки часового пояса

При изменении временной зоны все значения с типом TIMESTAMPTZ будут выводиться с учётом текущей активной временной зоны.

## Определение возраста

Неправильный подход — вычисление разницы годов:

```sql
SELECT EXTRACT(YEAR FROM NOW()) - EXTRACT(YEAR FROM TIMESTAMP '2003-07-03 14:10:26');
```
Не учитывает, был ли день рождения в этом году

Неправильный подход — разница дней, делённая на 365:

```sql
SELECT FLOOR(EXTRACT(DAY FROM NOW() - TIMESTAMP '2003-07-03 14:10:26') / 365);
```
Не учитывает високосные годы

Правильный подход — использование функции AGE:

```sql
SELECT EXTRACT(YEAR FROM AGE(NOW(), TIMESTAMP '2003-07-03 14:10:26'));
```
Корректное определение возраста с учётом дня рождения и високосных годов

Функция AGE вычисляет точный интервал между двумя датами.
