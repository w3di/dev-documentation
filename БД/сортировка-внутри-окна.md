## Сортировка внутри окна

Сортировка в оконных функциях SQL позволяет упорядочивать данные внутри определённой группы или окна, обеспечивая более точные и нацеленные агрегатные вычисления.

## Зачем нужна сортировка в окне

Сортировка в оконных функциях особенно полезна при:
- работе с временными рядами, где важен порядок событий
- ранжировании данных внутри групп
- вычислении накопительных сумм

## Пример использования

Задача: проанализировать данные о бронированиях жилых помещений, чтобы выяснить, как менялась общая сумма затраченных средств на аренду для каждого пользователя со временем.

Разделение данных на партиции без сортировки:

```sql
SELECT user_id,
       start_date,
       total AS reservation_price,
       SUM(total) OVER (
            PARTITION BY user_id
       ) AS total_expenses
FROM Reservations;
```
Выводит общую сумму затраченных средств с разбивкой по пользователям

Результат — в колонке total_expenses вывелась общая сумма затраченных средств с разбивкой по пользователям, но данные не упорядочены по дате, и не видно, как общие расходы росли со временем.

Добавление сортировки по дате начала бронирования:

```sql
SELECT user_id,
       start_date,
       total AS reservation_price,
       SUM(total) OVER (
           PARTITION BY user_id
           ORDER BY start_date
       ) AS cumulative_total
FROM Reservations;
```
Вычисляет накопительную сумму затрат с сортировкой по дате

Что изменилось после добавления ORDER BY start_date:
- Данные в рамках партиции стали отсортированы по дате начала бронирования
- Изменился способ подсчёта общей суммы затраченных средств: теперь сумма в рамках партиции накапливается, а не выводится как финальная

## Особенности использования сортировки без указания рамок окна

Полный синтаксис оконной функции:

```sql
SELECT <оконная_функция>(<поле_таблицы>)
OVER (
      [PARTITION BY <столбцы_для_разделения>]
      [ORDER BY <столбцы_для_сортировки>]
      [ROWS|RANGE <определение_диапазона_строк>]
)
```
Полная структура оконной функции

Блок ROWS|RANGE позволяет указать рамки окна относительно текущей строки, которые будут использоваться для вычисления в оконной функции.

Можно указать, чтобы при подсчёте значений для текущей строки в оконную функцию отправились не все записи в рамках текущей партиции, а только N записей до текущей строки и N после.

При использовании ORDER BY, если в блоке ROWS|RANGE ничего не указано, то в оконной функции автоматически применяется правило:

```sql
RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
```
Значение по умолчанию при использовании ORDER BY

Это означает, что окно будет начинаться с первой строки и заканчиваться текущей строкой.

Таким образом, значения для колонки cumulative_total будут высчитываться следующим образом:
- Для 1-й строки: сумма только 1-й строки
- Для 2-й строки: сумма 1-й и 2-й строк
- Для 3-й строки: сумма 1-й, 2-й и 3-й строк
- И так далее — накопительная сумма

Именно поэтому при добавлении ORDER BY получается накопительная (кумулятивная) сумма, а не финальная сумма для всей партиции.
