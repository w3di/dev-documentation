## Многотабличные запросы

В реальности часто требуется делать выборку из нескольких таблиц, объединяя их. Для этого используется оператор JOIN.

```sql
SELECT family_member, amount * unit_price AS price FROM Payments
```
Выводит идентификаторы из таблицы Payments, которые малоинформативны

```sql
SELECT family_member, member_name, amount * unit_price AS price FROM Payments
INNER JOIN FamilyMembers
    ON Payments.family_member = FamilyMembers.member_id
```
Объединяет таблицы Payments и FamilyMembers, заменяя идентификаторы на имена

## Общая структура многотабличного запроса

```sql
SELECT поля_таблиц
FROM таблица_1
[INNER] | [[LEFT | RIGHT | FULL][OUTER]] JOIN таблица_2
    ON условие_соединения
[[INNER] | [[LEFT | RIGHT | FULL][OUTER]] JOIN таблица_n
    ON условие_соединения]
```
Общая структура запроса с JOIN

Типы соединений:
- INNER — внутреннее (по умолчанию)
- OUTER — внешнее, делится на LEFT, RIGHT и FULL

## Внутреннее соединение INNER JOIN

```sql
SELECT поля_таблиц
FROM таблица_1
[INNER] JOIN таблица_2
    ON условие_соединения
[[INNER] JOIN таблица_n
    ON условие_соединения]
```
Общая структура запроса с INNER JOIN

```sql
SELECT family_member, member_name FROM Payments
INNER JOIN FamilyMembers
    ON Payments.family_member = FamilyMembers.member_id
```
Пример внутреннего соединения таблиц Payments и FamilyMembers

INNER является опциональным. По умолчанию JOIN выполняется как INNER JOIN, поэтому можно писать просто JOIN.

Внутреннее соединение находит пары записей из двух таблиц, удовлетворяющие условию соединения, и образует новую таблицу, содержащую поля из первой и второй исходных таблиц.

В итоговую выборку попадают только записи, где в обеих таблицах есть совпадающие значения по условию соединения.

## Внешнее соединение OUTER JOIN

Внешнее соединение может быть трёх типов: левое (LEFT), правое (RIGHT) и полное (FULL).

Главным отличием внешнего соединения от внутреннего является то, что оно обязательно возвращает все строки одной (LEFT, RIGHT) или двух таблиц (FULL).

## Внешнее левое соединение LEFT OUTER JOIN

LEFT OUTER JOIN возвращает все значения из левой таблицы, соединённые с соответствующими значениями из правой таблицы, если они удовлетворяют условию соединения, или заменяет их на NULL в обратном случае.

```sql
SELECT поля_таблиц 
FROM левая_таблица LEFT JOIN правая_таблица 
    ON правая_таблица.ключ = левая_таблица.ключ
```
Общая структура LEFT JOIN

```sql
SELECT Timepair.id, start_pair, end_pair,
    Schedule.id, date, class, number_pair
FROM Timepair
LEFT JOIN Schedule ON Schedule.number_pair = Timepair.id
```
Возвращает все строки из таблицы Timepair, дополненные данными из Schedule. Строки без соответствия в правой таблице содержат NULL.

Ключевое слово OUTER является опциональным, можно писать просто LEFT JOIN.

## Внешнее правое соединение RIGHT OUTER JOIN

RIGHT OUTER JOIN возвращает все значения из правой таблицы, соединённые с соответствующими значениями из левой таблицы, если они удовлетворяют условию соединения, или заменяет их на NULL в обратном случае.

```sql
SELECT поля_таблиц
FROM левая_таблица RIGHT JOIN правая_таблица
    ON правая_таблица.ключ = левая_таблица.ключ
```
Общая структура RIGHT JOIN

## Внешнее полное соединение FULL OUTER JOIN

FULL OUTER JOIN выполняет внутреннее соединение записей и дополняет их левым внешним соединением и правым внешним соединением.

Алгоритм работы:
1. Формируется таблица на основе внутреннего соединения (INNER JOIN)
2. В таблицу добавляются значения, не вошедшие в результат формирования из левой таблицы (LEFT OUTER JOIN)
3. В таблицу добавляются значения, не вошедшие в результат формирования из правой таблицы (RIGHT OUTER JOIN)

```sql
SELECT поля_таблиц
FROM левая_таблица
    FULL OUTER JOIN правая_таблица
    ON правая_таблица.ключ = левая_таблица.ключ
```
Общая структура FULL JOIN

## Базовые варианты объединения таблиц

Получение всех данных из левой таблицы, соединённых с соответствующими данными из правой:

```sql
SELECT поля_таблиц 
FROM левая_таблица LEFT JOIN правая_таблица 
    ON правая_таблица.ключ = левая_таблица.ключ
```

Получение всех данных из правой таблицы, соединённых с соответствующими данными из левой:

```sql
SELECT поля_таблиц
FROM левая_таблица RIGHT JOIN правая_таблица
    ON правая_таблица.ключ = левая_таблица.ключ
```

Получение данных, относящихся только к левой таблице:

```sql
SELECT поля_таблиц
FROM левая_таблица LEFT JOIN правая_таблица
    ON правая_таблица.ключ = левая_таблица.ключ
WHERE правая_таблица.ключ IS NULL
```

Получение данных, относящихся только к правой таблице:

```sql
SELECT поля_таблиц
FROM левая_таблица RIGHT JOIN правая_таблица
    ON правая_таблица.ключ = левая_таблица.ключ
WHERE левая_таблица.ключ IS NULL
```

Получение данных, относящихся как к левой, так и к правой таблице:

```sql
SELECT поля_таблиц
FROM левая_таблица INNER JOIN правая_таблица
    ON правая_таблица.ключ = левая_таблица.ключ
```

Получение всех данных, относящихся к левой и правой таблицам, а также их внутреннему соединению:

```sql
SELECT поля_таблиц
FROM левая_таблица
    FULL OUTER JOIN правая_таблица
    ON правая_таблица.ключ = левая_таблица.ключ
```

Получение данных, не относящихся к левой и правой таблицам одновременно (обратное INNER JOIN):

```sql
SELECT поля_таблиц
FROM левая_таблица
    FULL OUTER JOIN правая_таблица
    ON правая_таблица.ключ = левая_таблица.ключ
WHERE левая_таблица.ключ IS NULL
    OR правая_таблица.ключ IS NULL
```

## Использование WHERE для соединения таблиц

Для внутреннего соединения таблиц также можно использовать оператор WHERE вместо INNER JOIN:

```sql
SELECT family_member, member_name FROM Payments, FamilyMembers
WHERE Payments.family_member = FamilyMembers.member_id
```
Альтернативный способ внутреннего соединения через WHERE

Этот способ эквивалентен INNER JOIN, но менее нагляден и рекомендуется использовать явный JOIN.

## Условие соединения ON

Условие соединения указывается после ON и определяет, как записи из двух таблиц сопоставляются друг с другом.

```sql
ON Payments.family_member = FamilyMembers.member_id
```
Сопоставляет записи по равенству столбцов

В большинстве случаев условием соединения является равенство столбцов таблиц (таблица_1.поле = таблица_2.поле), однако можно использовать и другие операторы сравнения.

## Вывод столбцов в многотабличном запросе

Символ * в многотабличном запросе означает "вывести все столбцы из таблиц, перечисленных в выражении FROM".

Для вывода столбцов конкретной таблицы используется конструкция таблица.*:

```sql
SELECT FamilyMembers.* FROM Payments
INNER JOIN FamilyMembers
    ON Payments.family_member = FamilyMembers.member_id
```
Выводит только столбцы из таблицы FamilyMembers

```sql
SELECT Payments.*, FamilyMembers.* FROM Payments
INNER JOIN FamilyMembers
    ON Payments.family_member = FamilyMembers.member_id
```
Выводит все столбцы из обеих таблиц

Можно комбинировать отдельные столбцы и все столбцы таблицы:

```sql
SELECT payment_id, family_member, FamilyMembers.* FROM Payments
INNER JOIN FamilyMembers
    ON Payments.family_member = FamilyMembers.member_id
```
Выводит указанные столбцы из Payments и все столбцы из FamilyMembers

## Псевдонимы для таблиц

Псевдонимы улучшают читаемость кода и помогают избежать ошибок в сложных запросах.

```sql
SELECT id, name
FROM Passenger AS pass
```
Псевдоним задаётся через ключевое слово AS

```sql
SELECT pass.id, pass.name
FROM Passenger AS pass
```
Обращение к столбцам через псевдоним

Ключевое слово AS является опциональным, как и у псевдонимов столбцов.

После назначения псевдонима столбцы доступны только через псевдоним, а не через оригинальное название таблицы.

```sql
SELECT
    pass.id,
    pass.name
FROM Passenger AS pass
INNER JOIN Pass_in_trip AS pit
    ON pit.passenger = pass.id
```
Пример запроса с псевдонимами для нескольких таблиц

Если в обеих таблицах есть поле с одинаковым названием и не указано из какой таблицы его брать, СУБД возьмёт значение из последней таблицы в цепочке JOIN.

Правила использования псевдонимов:
- Используйте логичные сокращения (например, первые буквы названия таблицы)
- Избегайте слишком коротких (однобуквенных) или неочевидных псевдонимов
