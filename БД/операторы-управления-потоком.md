## Операторы IF, CASE, WHILE в хранимых процедурах

Хранимые процедуры и функции позволяют реализовать сложную логику, используя операторы ветвления и циклы.

Основные операторы управления потоком выполнения: условные операторы `IF` и `CASE`, а также циклы `WHILE`.

## Условный оператор IF

Оператор `IF` позволяет выполнять код в зависимости от выполнения условия.

Синтаксис:

```sql
IF условие THEN
    -- код, выполняемый при истинном условии
ELSIF другое_условие THEN
    -- код для альтернативного условия
ELSE
    -- код по умолчанию
END IF;
```

Пример использования:

```sql
CREATE OR REPLACE FUNCTION categorize_student_by_age(student_id INT)
RETURNS VARCHAR(20)
LANGUAGE plpgsql
AS $$
DECLARE
    student_age INT;
    category VARCHAR(20);
BEGIN
    SELECT EXTRACT(YEAR FROM AGE(CURRENT_DATE, birthday))
    INTO student_age
    FROM Student
    WHERE id = student_id;

    IF student_age < 18 THEN
        category := 'Несовершеннолетний';
    ELSIF student_age BETWEEN 18 AND 25 THEN
        category := 'Молодой';
    ELSE
        category := 'Взрослый';
    END IF;

    RETURN category;
END;
$$;
```

Использование:

```sql
SELECT categorize_student_by_age(1) AS age_category;
```

## Оператор выбора CASE

Оператор `CASE` предоставляет более элегантный способ обработки множественных условий.

Синтаксис:

```sql
CASE
    WHEN условие1 THEN результат1
    WHEN условие2 THEN результат2
    ELSE результат_по_умолчанию
END CASE;
```

Пример использования:

```sql
CREATE OR REPLACE FUNCTION categorize_student_with_case(student_id INT)
RETURNS VARCHAR(20)
LANGUAGE plpgsql
AS $$
DECLARE
    student_age INT;
    category VARCHAR(20);
BEGIN
    SELECT EXTRACT(YEAR FROM AGE(CURRENT_DATE, birthday))
    INTO student_age
    FROM Student
    WHERE id = student_id;

    category := CASE
        WHEN student_age < 18 THEN 'Несовершеннолетний'
        WHEN student_age BETWEEN 18 AND 25 THEN 'Молодой'
        ELSE 'Взрослый'
    END;

    RETURN category;
END;
$$;
```

Использование:

```sql
SELECT categorize_student_with_case(1) AS age_category;
```

## Цикл WHILE

Цикл `WHILE` позволяет выполнять код повторно, пока выполняется определённое условие.

Синтаксис:

```sql
WHILE условие LOOP
    -- код, выполняемый в цикле
END LOOP;
```

Пример использования:

```sql
CREATE OR REPLACE PROCEDURE create_test_subjects(count_subjects INT)
LANGUAGE plpgsql
AS $$
DECLARE
    i INT := 1;
    subject_id INT := 20;
BEGIN
    WHILE i <= count_subjects LOOP
        INSERT INTO Subject (id, name)
        VALUES (subject_id + i, 'Test Subject ' || i);

        i := i + 1;
    END LOOP;

    RAISE NOTICE 'Создано % тестовых предметов', count_subjects;
END;
$$;
```

Использование:

```sql
CALL create_test_subjects(3);
```

Проверка результата:

```sql
SELECT * FROM Subject WHERE name LIKE 'Test Subject%';
```

## Оператор присваивания

В PL/pgSQL для присваивания значений переменным используется оператор `:=`:

```sql
category := 'Молодой';
i := i + 1;
```

## Оператор RAISE

Оператор `RAISE` используется для вывода сообщений:

```sql
RAISE NOTICE 'Создано % тестовых предметов', count_subjects;
```

Уровни сообщений:
- `NOTICE` — информационное сообщение
- `WARNING` — предупреждение
- `EXCEPTION` — ошибка

## Преимущества операторов управления потоком

- Реализация сложной бизнес-логики
- Условное выполнение кода
- Циклическая обработка данных
- Гибкость в управлении логикой процедур и функций
