## Основные оконные функции

Оконные функции можно разделить на 3 группы:
- Агрегатные оконные функции
- Ранжирующие оконные функции
- Оконные функции смещения

## Агрегатные оконные функции

Агрегатные функции выполняют на наборе данных арифметические вычисления и возвращают итоговое значение.

- SUM — подсчитывает общую сумму значений
- COUNT — считает общее количество записей в колонке
- AVG — рассчитывает среднее арифметическое
- MAX — находит наибольшее значение
- MIN — определяет наименьшее значение

```sql
SELECT id,
	home_type,
	price,
	SUM(price) OVER(PARTITION BY home_type) AS "Sum",
	COUNT(price) OVER(PARTITION BY home_type) AS "Count",
	AVG(price) OVER(PARTITION BY home_type) AS "Avg",
	MAX(price) OVER(PARTITION BY home_type) AS "Max",
	MIN(price) OVER(PARTITION BY home_type) AS "Min"
FROM Rooms;
```
Пример использования агрегатных оконных функций

## Ранжирующие оконные функции

Ранжирующие оконные функции ранжируют значение для каждой строки в окне.

В ранжирующих функциях под ключевым словом OVER обязательным идёт указание условия ORDER BY, по которому будет происходить сортировка ранжирования.

## ROW_NUMBER

ROW_NUMBER — возвращает номер строки, используется для нумерации.

```sql
ROW_NUMBER() OVER(PARTITION BY home_type ORDER BY price)
```
Присваивает уникальный номер каждой строке

## RANK

RANK — возвращает ранг каждой строки.

Как работает:
1. Сортировка: строки сортируются по столбцам, указанным в ORDER BY
2. Присвоение рангов: каждой уникальной строке или группе строк присваивается ранг, начиная с 1
3. Одинаковые значения: строки с одинаковыми значениями получают одинаковый ранг
4. Пропуск рангов: после группы строк с одинаковым рангом, следующий ранг увеличивается на количество строк в этой группе

```sql
RANK() OVER(PARTITION BY home_type ORDER BY price)
```
Если две строки имеют ранг 2, следующая строка получит ранг 4, а не 3

## DENSE_RANK

DENSE_RANK — возвращает ранг каждой строки. В отличие от RANK, не пропускает ранги.

После группы одинаковых значений ранг увеличивается на единицу, а не на количество строк.

```sql
DENSE_RANK() OVER(PARTITION BY home_type ORDER BY price)
```
Если две строки имеют ранг 2, следующая строка получит ранг 3, а не 4

Пример использования ранжирующих функций:

```sql
SELECT id,
	home_type,
	price,
	ROW_NUMBER() OVER(PARTITION BY home_type ORDER BY price) AS "row_number",
	RANK() OVER(PARTITION BY home_type ORDER BY price) AS "rank",
	DENSE_RANK() OVER(PARTITION BY home_type ORDER BY price) AS "dense_rank"
FROM Rooms;
```
Сравнение ROW_NUMBER, RANK и DENSE_RANK

## Оконные функции смещения

Оконные функции смещения позволяют перемещаться и обращаться к разным строкам в окне, относительно текущей строки, а также обращаться к значениям в начале или в конце окна.

## LAG

LAG — обращается к данным из предыдущих строк окна.

Аргументы:
1. Столбец, значение которого необходимо вернуть
2. Количество строк для смещения (по умолчанию 1)
3. Значение, которое необходимо вернуть, если после смещения возвращается NULL

```sql
LAG(price) OVER(PARTITION BY home_type ORDER BY price)
LAG(price, 2) OVER(PARTITION BY home_type ORDER BY price)
```
LAG возвращает значение из предыдущей строки

## LEAD

LEAD — обращается к данным из следующих строк. Аналогично LAG имеет 3 аргумента.

```sql
LEAD(price) OVER(PARTITION BY home_type ORDER BY price)
```
LEAD возвращает значение из следующей строки

## FIRST_VALUE

FIRST_VALUE — возвращает первое значение в окне.

Принимает столбец, значение которого необходимо вернуть.

```sql
FIRST_VALUE(price) OVER(PARTITION BY home_type ORDER BY price)
```
Возвращает первое значение в окне

## LAST_VALUE

LAST_VALUE — возвращает последнее значение в окне.

Принимает столбец, значение которого необходимо вернуть.

```sql
LAST_VALUE(price) OVER(PARTITION BY home_type ORDER BY price)
```
Возвращает последнее значение в окне

Пример использования функций смещения:

```sql
SELECT id,
	home_type,
	price,
	LAG(price) OVER(PARTITION BY home_type ORDER BY price) AS "lag",
	LAG(price, 2) OVER(PARTITION BY home_type ORDER BY price) AS "lag_2",
	LEAD(price) OVER(PARTITION BY home_type ORDER BY price) AS "lead",
	FIRST_VALUE(price) OVER(PARTITION BY home_type ORDER BY price) AS "first_value",
	LAST_VALUE(price) OVER(PARTITION BY home_type ORDER BY price) AS "last_value"
FROM Rooms;
```
Пример использования LAG, LEAD, FIRST_VALUE и LAST_VALUE
