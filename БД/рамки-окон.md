## Рамки окон

В контексте оконных функций SQL, «окно» определяет подмножество строк, которые рассматриваются SQL-функцией при выполнении вычислений.

Окно — это динамический набор строк, который "скользит" по результату запроса, образуя различные наборы данных для каждой строки, в зависимости от заданного определения окна.

## Окно vs Партиции

Хотя термины "окно" и "партиция" могут показаться схожими, они представляют разные концепции:

Партиция (PARTITION BY):
- Деление всего набора результатов на непересекающиеся подмножества
- Каждое подмножество содержит строки с одинаковыми значениями в одном или нескольких столбцах
- Оконные функции применяются отдельно к каждой партиции

Окно:
- Определяет, какие конкретные строки в каждой партиции будут использоваться для вычисления оконной функции для каждой строки
- Окно может изменяться от строки к строке
- Это как "подпартиция" внутри уже существующей партиции

```sql
... ROWS BETWEEN 1 PRECEDING AND CURRENT ROW
```
Пример: окно состоит из текущей строки и одной предшествующей строки

Для каждой строки:
- Первое окно состоит только из 1-й записи (предыдущей записи нет)
- Второе окно содержит 1-ю и 2-ю записи
- Третье окно содержит 2-ю и 3-ю записи
- И так далее — окно "скользит" по таблице

## Примечание об окне без ROWS/RANGE

Если в определении оконной функции отсутствует ROWS/RANGE, тогда окно по умолчанию совпадает с партицией.

В этом случае оконная функция будет обрабатывать все строки внутри партиции, не ограничиваясь подмножеством. Результат функции будет одинаков для всех строк внутри той же партиции.

## Определение границ окон

Используя синтаксис ROWS или RANGE, можно определить какое именно окно с данными будет передаваться в оконную функцию для вычисления значения для текущей строки.

```sql
SELECT <оконная_функция>(<поле_таблицы>)
OVER (
      ...
      ROWS|RANGE BETWEEN <начало границы окна> AND <конец границы окна>
)
```
Синтаксис определения границ окна

```sql
... ROWS|RANGE BETWEEN 2 PRECEDING AND CURRENT ROW
```
В оконную функцию попадают две предыдущие записи и текущая строка

```sql
... ROWS|RANGE BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING
```
В оконную функцию передаются текущая строка и все последующие

## Возможные определения границ окна

- UNBOUNDED PRECEDING — все строки, предшествующие текущей
- N PRECEDING — N строк до текущей строки
- CURRENT ROW — текущая строка
- N FOLLOWING — N строк после текущей строки
- UNBOUNDED FOLLOWING — все последующие строки

## Отличие ROWS от RANGE

Для определения границ окна используются ключевые слова ROWS и RANGE. Работают они по-разному.

## ROWS

Основан на физических строках:
- Определение окна основывается на физическом положении строк относительно текущей строки
- Например, 1 PRECEDING означает одну строку до текущей

Точная граница:
- Чётко ограничивает количество строк, которые включаются в окно
- Делает его предсказуемым и конкретным

## RANGE

Основан на значениях:
- Определяет границы окна на основе значений столбцов, упорядоченных в соответствии с ORDER BY в оконной функции

Динамичность границ:
- Границы могут варьироваться в зависимости от данных
- Делает окно гибким, но потенциально менее предсказуемым

## Разница между ROWS и RANGE

ROWS:
- Определяет границы окна на основе физического положения строк
- Фиксированное количество строк
- Предсказуемое поведение

RANGE:
- Определяет границы окна на основе значений столбцов
- Количество строк может варьироваться
- Гибкое поведение, зависящее от данных
