## Представления, VIEW

Хорошо спроектированные приложения обычно предоставляют открытый интерфейс, скрывая детали реализации, что позволяет вносить изменения в дизайн без влияния на конечных пользователей.

При разработке базы данных можно достичь аналогичного результата, закрывая таблицы и предоставляя доступ к данным только через набор представлений.

## Что такое представление

Представление — объект базы данных, являющийся результатом выполнения запроса к базе данных, определённого с помощью оператора `SELECT`, в момент обращения к представлению.

Представления иногда называют «виртуальными таблицами». Это связано с тем, что представление для пользователя выглядит как таблица, но фактически не хранит данных, а извлекает их из других таблиц в момент обращения.

Ключевые особенности:
- Представление не хранит данные
- Данные извлекаются из основных таблиц при каждом обращении
- Представления не кэшируют результаты выборки
- Если данные в основной таблице меняются, пользователь получает актуальные данные при обращении к представлению

## Пример создания представления

Предположим, вы хотите частично скрыть адреса электронной почты в таблице пользователей (Users).

Вместо того, чтобы разрешить прямой доступ к таблице пользователей, можно определить представление с именем `ViewUsers`:

```sql
CREATE VIEW ViewUsers AS
    SELECT id,
           name,
           CONCAT(SUBSTR(email, 1, 2), '****', RIGHT(email, 4)) AS email
FROM Users;
```

Использование представления:

```sql
SELECT * FROM ViewUsers;
```

Результат:

```
id    name                email
1     Bruce Willis        ba****.com
2     George Clooney      te****.com
3     Kevin Costner       me****.com
```

Представление в SQL-запросе выглядит и используется как обычная таблица.

## Общий синтаксис представления

```sql
CREATE [OR REPLACE] VIEW имя_представления [(имена_полей_представления)]
AS select_выражение
```

`OR REPLACE`:
- Опциональный параметр
- Если представление с таким именем уже существует, старое представление будет удалено, а новое создано
- В противном случае, при попытке создать представление с существующим именем, возникнет ошибка

## Просмотр информации о представлении

Для просмотра столбцов представления используется запрос к `information_schema`:

```sql
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'viewusers';
```

## Зачем нужны представления

### Упрощение сложных запросов

Представления используются для упрощения сложных запросов и создания абстракции между пользователем и базой данных.

Пример:

```sql
CREATE VIEW ActiveOrders AS
SELECT 
    o.id,
    o.order_date,
    u.name AS customer_name,
    u.email,
    SUM(oi.quantity * oi.price) AS total_amount
FROM Orders o
JOIN Users u ON o.user_id = u.id
JOIN OrderItems oi ON o.id = oi.order_id
WHERE o.status = 'active'
GROUP BY o.id, o.order_date, u.name, u.email;
```

Вместо написания сложного запроса каждый раз, можно просто использовать:

```sql
SELECT * FROM ActiveOrders;
```

### Улучшение производительности

Создание представлений, которые инкапсулируют сложные запросы, может помочь оптимизировать выполнение этих запросов.

PostgreSQL поддерживает материализованные представления (`MATERIALIZED VIEW`), которые физически хранят результаты запроса и периодически обновляются, что может значительно улучшить производительность для сложных запросов.

```sql
CREATE MATERIALIZED VIEW MonthlyStats AS
SELECT 
    DATE_TRUNC('month', order_date) AS month,
    COUNT(*) AS orders_count,
    SUM(total_amount) AS total_revenue
FROM Orders
GROUP BY DATE_TRUNC('month', order_date);
```

Обновление материализованного представления:

```sql
REFRESH MATERIALIZED VIEW MonthlyStats;
```

### Обеспечение безопасности

Представления могут использоваться для обеспечения безопасности конфиденциальных данных.

Создание представлений, которые ограничивают доступ к определённым столбцам или строкам данных, позволяет администраторам ограничить доступ к чувствительной информации.

Пример:

```sql
CREATE VIEW PublicUsers AS
SELECT id, name, country
FROM Users;
```

Это представление скрывает конфиденциальные данные (email, телефон, адрес) от пользователей, которым не нужен полный доступ.

## Обновление представлений

Изменение существующего представления:

```sql
CREATE OR REPLACE VIEW ViewUsers AS
    SELECT id,
           name,
           CONCAT(LEFT(email, 3), '***', RIGHT(email, 4)) AS email
FROM Users;
```

## Удаление представлений

Удаление представления:

```sql
DROP VIEW IF EXISTS ViewUsers;
```

## Ограничения представлений

- Представления могут снижать производительность для очень сложных запросов
- Не все представления могут быть обновляемыми (некоторые представления только для чтения)
- Изменения в структуре базовых таблиц могут нарушить работу представлений

## Примеры использования

### Представление для отчётов

```sql
CREATE VIEW SalesReport AS
SELECT 
    p.name AS product_name,
    c.name AS category_name,
    COUNT(oi.id) AS times_ordered,
    SUM(oi.quantity) AS total_quantity,
    SUM(oi.quantity * oi.price) AS total_revenue
FROM Products p
JOIN Categories c ON p.category_id = c.id
JOIN OrderItems oi ON p.id = oi.product_id
GROUP BY p.name, c.name;
```

### Представление для ограничения доступа

```sql
CREATE VIEW UserOrders AS
SELECT 
    o.id,
    o.order_date,
    o.total_amount
FROM Orders o
WHERE o.user_id = CURRENT_USER_ID();
```

### Представление для упрощения JOIN

```sql
CREATE VIEW ProductsWithCategories AS
SELECT 
    p.id,
    p.name AS product_name,
    p.price,
    c.name AS category_name
FROM Products p
LEFT JOIN Categories c ON p.category_id = c.id;
```

## Итоги

Представления являются важным инструментом в SQL, который позволяет:
- Упростить сложные запросы
- Стандартизировать доступ к данным
- Повысить производительность (через материализованные представления)
- Обеспечить безопасность данных
- Создать уровень абстракции между пользователями и базовыми таблицами
