### Partial Pre-rendering (PPR) — краткий конспект (теория)

- **Определение**: PPR — это стратегия рендеринга, которая сочетает преимущества статического пререндеринга и динамического рендеринга на одной странице. Статическая «оболочка» (shell) отдается мгновенно с Edge, а динамические части дорендериваются и подstream’иваются по готовности.

### Зачем это нужно
- **Комбинировать модели**: даже статичные страницы нередко имеют небольшие динамические зоны (навигация с пользователем, персонализация), а динамические — большие неизменные блоки.
- **Производительность**: быстрый первый ответ с Edge (как у SSG) + последующая подгрузка динамики (как у SSR/DSR).
- **Гибкость**: не нужно выбирать «всё статично» или «всё динамично» на уровне страницы.

### Как это работает (высокоуровнево)
- **Статическая часть**: максимально возможная часть страницы пререндерится на билде и кэшируется/распространяется на Edge.
- **Динамические зоны**: изолируются границами React Suspense, чтобы использование runtime‑API внутри них не «заражало» всю страницу динамичностью.
- **Во время запроса**: пользователь мгновенно получает статическую оболочку; параллельно запускается рендер динамики на рантайм‑сервере, и результат потоково подставляется на клиенте по готовности.

### Ключевая механика
- **Suspense‑границы**: служат «барьерами», которые удерживают динамические зависимости внутри себя, не переводя всю страницу в динамический режим.
- **Стриминг**: сервер разбивает вывод на чанки и отправляет их по мере готовности; браузер постепенно заполняет «дыры» динамическим контентом вместо плейсхолдеров.
- **Сигналы о динамичности**: использование runtime‑API и некэшированных запросов внутри границы делает только этот участок динамическим, а не всю страницу.

### Чем отличается от SSR/SSG
- **От чистого SSR**: нет «пустого ожидания» первой байты для всей страницы — статическая оболочка приходит сразу, динамика догружается постепенно.
- **От чистого SSG**: можно иметь динамические зоны без перевода всей страницы в runtime‑рендеринг.

### Где это особенно полезно
- Страницы документации/блогов: основное содержимое статично, а верхняя панель/персонализация — динамичны.
- Лэндинги и маркетинг: быстрый «первый пиксель» со статической оболочкой + индивидуальные блоки (акции, входы пользователя).
- Дашборды: общий каркас статичен, виджеты/метрики — динамичны.

### Роль Middleware и маршрутизации
- **Middleware**: может переписывать (rewrite) на разные статические оболочки по флагам/локали/статусу входа, усиливая эффект PPR.
- **Роутинг**: PPR не меняет систему маршрутов; он влияет на стратегию рендеринга участков страницы.

### Кэширование и актуализация
- **Статика**: распространяется через Edge; выигрывает от CDN‑кэша и мгновенной доставки.
- **Динамика**: может использовать серверное кэширование данных, чтобы уменьшить задержки; совместима со streaming и ISR там, где уместно.

### Пользовательское восприятие
- **Быстрый TTFB**: браузер получает HTML‑оболочку сразу и начинает отрисовку, загрузку статических ассетов и активацию клиентских компонент.
- **Постепенная «дорисовка»**: динамические зоны «включаются» по мере готовности, заменяя статические фолбэки реальным контентом.

### Ограничения и статус
- **Границы ответственности**: требуется сознательное выделение динамических зон через Suspense, чтобы не сделать страницу полностью динамичной.
- **Инфраструктура**: наилучший эффект при наличии Edge‑сети и поддержке стриминга.
- **Статус**: технология развивается; следите за обновлениями в блоге Next.js перед использованием в продакшене.

### Практические рекомендации
- Выделяйте динамику точечно с помощью Suspense, а остальное оставляйте статикой.
- Минимизируйте количество и «вес» динамических зависимостей; используйте кэш данных.
- Совмещайте с Middleware для вариаций статической оболочки (флаги, локаль, состояние аутентификации).
- Следите за тем, чтобы фолбэки внутри Suspense были содержательными и лёгкими.
- Не пытайтесь «насильно» делать динамичным то, что может быть статичным; PPR раскрывается, когда статическое и динамическое сосуществуют.

---

### Статус и предназначение
- Фича **экспериментальная** и может меняться; не рекомендуется для продакшена до стабилизации. Хороша для оценки и обратной связи.
- **Цель**: объединить статическое и динамическое содержимое в одном маршруте, улучшив начальную производительность и сохранив персонализацию.

### Как это работает по шагам
1) При визите маршрута сервер отправляет **статическую оболочку** (shell) — быстрый первый рендер.
2) В оболочке оставляются **«дыры» для динамики**, которые заполняются асинхронно.
3) Динамические части **стримятся параллельно**, уменьшая общее время загрузки.

### Связанные стратегии рендеринга
- **Static Rendering**: HTML генерируется заранее (на билде или при ревалидации), кешируется и шарится между пользователями. В PPR — это статическая «оболочка» (layout и все, что не зависит от данных запроса).
- **Dynamic Rendering**: HTML генерируется на каждый запрос (персонализация по данным рантайма). В PPR динамика изолируется, чтобы не переводить всю страницу в runtime.

### Что делает компонент динамическим
Компонент становится динамическим при использовании API рантайма, например:
- cookies
- headers
- connection
- draftMode
- проп `searchParams`
- unstable_noStore
- fetch с `{ cache: 'no-store' }`

В PPR использование этих API вне динамической границы приводит к специальной ошибке сборки (сигнал React/Next.js, что участок не может быть статическим). Решение — обернуть такой участок в границу Suspense, чтобы отложить его рендеринг до рантайма.

### Роль Suspense
- Suspense используется для **разметки динамических границ** в дереве компонентов.
- На билде Next.js пререндерит **статический контент и fallback‑UI**, а **динамический контент откладывается** до запроса.
- Важно: Suspense сам по себе не делает компонент динамическим; динамичность определяет **факт доступа к runtime‑API**. Suspense лишь изолирует динамику и включает **стриминг** для её границы.

### Стриминг (Streaming)
- Разделяет маршрут на чанки и **постепенно отдает** их на клиент по готовности.
- Дает пользователю увидеть части страницы сразу, до полной готовности всего контента.
- В PPR динамические части внутри Suspense **стримятся параллельно**.
- Чтобы сократить накладные расходы, **полный ответ** (статический HTML + динамические части) отправляется в рамках **одного HTTP‑ответа**.

### Включение PPR (opt‑in)
- Включается глобально через экспериментальную опцию в конфиге и **адоптируется по маршрутам**.
- Для конкретного маршрута (сегмента) включается **флагом на уровне сегмента**.
- Маршруты без явного включения PPR **остаются без PPR** (поведение по умолчанию — выключено).

### Наследование флага
- Флаг включения PPR на сегменте **распространяется на всех его детей**, включая вложенные layout’ы и страницы.
- Чтобы **отключить PPR у дочерних сегментов**, в них можно выставить флаг‑отключение.

### Практические паттерны
- **Динамические API**: если участок использует runtime‑API (например, cookies/headers), оборачивайте его **в Suspense**. Тогда статическая оболочка попадет в пререндер, а динамический блок будет подstream’ен по готовности.
- **Передача динамических пропов**: компонент становится динамическим **только в момент доступа** к значению. Пропсы можно пробрасывать через статичный слой; динамика «срабатывает» там, где значение реально читается. Это позволяет изолировать динамичность и сохранить статичность остальной части страницы.
- **Устойчивые fallback’и**: продумывайте содержательные, легкие fallback‑состояния для динамических зон — они будут видны пользователю, пока поток не заполнит «дыры».
- **Сосуществование стратегий**: используйте PPR вместе с ISR/кешированием данных и, при необходимости, с middleware для раздачи разных статических оболочек по признакам (локаль, фича‑флаги, состояние входа).

### Пользовательский эффект
- **Быстрый старт**: за счет статической оболочки сокращается TTFB и появляется мгновимый «первый пиксель».
- **Постепенная дорисовка**: динамика догружается без блокировки, заметно улучшая общую воспринимаемую скорость.

### Ограничения и замечания
- Требуется дисциплина в выделении **динамических границ** (иначе можно ненароком сделать весь маршрут динамическим).
- Наибольшая польза достигается при **Edge‑доставке** статики и поддержке **стриминга**.
- Фича **в активной разработке**: следите за обновлениями Next.js и релиз‑нотами перед продакшен‑использованием.
