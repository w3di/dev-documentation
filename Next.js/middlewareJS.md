### Next.js Middleware — краткий конспект (теория)

- **Назначение**: запуск серверной логики до завершения запроса. Полезно для аутентификации, логирования, редиректов/переписываний, заголовков, CORS, куки.
- **Где хранить**: файл `middleware.ts|js` в корне проекта или в `src/` на одном уровне с `pages` или `app`.

### Экспорт и сигнатуры
- **Едиственная функция**: дефолтный экспорт или именованная функция `middleware(request)`; множественные мидлвары в одном файле не поддерживаются.
- **Параметры**: `request: NextRequest` (доступны `request.nextUrl`, `headers`, `cookies`).
- **Ответ**: вернуть `NextResponse` или `Response`, либо `NextResponse.next()` для пропуска.

### NextResponse — основные возможности
- **Redirect**: перенаправление на другой URL (3xx).
- **Rewrite**: отрисовка другого маршрута при сохранении исходного URL в адресной строке.
- **Next**: продолжение цепочки с возможностью пробросить изменённые заголовки запроса вверх по пайплайну.
- **Cookies**: чтение/установка/удаление для запроса и ответа.
- **Headers**: установка/чтение заголовков ответа.

### Config (опционально)
- **matcher** — указывает, где запускается Middleware.
  - Варианты: одиночный путь (строка), массив путей, паттерны и регулярные выражения (в стиле path‑to‑regexp), negative lookahead для исключений.
  - Объектная форма поддерживает ключи: `source`, `regexp` (опц.), `locale` (опц.), `has` (опц.), `missing` (опц.).
  - Правила: путь начинается с `/`; поддерживаются именные параметры `:param` и модификаторы `* ? +`; значения — константы (для статического анализа на билде).
- **runtime**: по умолчанию Edge; при необходимости можно задать `nodejs`.

### Что можно делать в Middleware (перечень задач)
- **Аутентификация и авторизация**: ранняя проверка токена; редирект на логин; защита маршрутов.
- **Тихое обновление сессии**: попытка refresh access по refresh‑куке до SSR/рендера.
- **Редиректы и переписывания**: миграции URL, каноникализация (слэш, www, http→https), поддержка legacy‑роутов.
- **Гео/локаль‑роутинг**: выбор языка/региона по GeoIP/`Accept-Language`, маршрутизация на поддомены/префиксы.
- **Мульти‑тенантность**: маппинг домена/поддомена на tenant/workspace.
- **CORS**: ответы на preflight (OPTIONS) и установка CORS‑заголовков для простых запросов.
- **Заголовки безопасности и кэширования**: CSP, HSTS, `X-Frame-Options`, `Cache-Control`, `Vary` и пр.
- **Куки**: чтение/установка httpOnly/Secure для сессий, фич, A/B‑тестов.
- **A/B‑тесты и feature flags**: расщепление трафика, метки, направляние на разные версии.
- **Рейт‑лимитинг и защита**: ограничение по IP/токену, блокировка ботов, deny/allow‑листы.
- **Логирование и телеметрия**: сбор метаданных и отправка асинхронно через `waitUntil`.
- **Девайс/агент‑детект**: ветвление на mobile/desktop ветки, минимальные подсказочные заголовки.
- **Фильтрация префетчей**: игнор запросов с `next-router-prefetch`/`purpose=prefetch`.
- **Техработы/баннеры**: быстрый ответ 503/JSON для всего трафика без захода в роуты.
- **Ограничения по времени/странам/листам**: ранняя блокировка/редирект.
- **Нормализация URL**: собственные правила для хвостового слэша/регистра/квери (с флагами skip*).

### Порядок выполнения (подробно)
1. **headers из `next.config.js`**
   - На самом раннем этапе применяются заголовки, определённые в конфиге (например, CSP/HSTS/`X-Frame-Options`).
   - Эти заголовки действуют глобально и могут повлиять на кэширование/безопасность ещё до пользовательской логики.
2. **redirects из `next.config.js`**
   - Глобальные редиректы (301/302/307/308) выполняются до любого пользовательского кода.
   - Используются для постоянных правил маршрутизации и SEO‑каноникализации; экономят выполнение Middleware там, где он не нужен.
3. **Middleware (rewrites, redirects и прочее)**
   - Точка кастомной логики перед файловыми маршрутами: аутентификация, AB‑тесты, CORS, модификация заголовков, ранние ответы.
   - Важно правильно ограничить область `matcher`, чтобы не обрабатывать служебные пути (`_next/static`, изображения, favicon и т.д.).
4. **beforeFiles (rewrites) из `next.config.js`**
   - Переписывания до файловой системы: позволяют направить запрос на другой путь ещё до поиска реального файла/страницы.
   - Подходят для глобальных правил, не зависящих от данных запроса.
5. **Файловые роуты**
   - Проверяются статические активы (`public/`, `_next/static/`), а также страницы из `pages/` и `app/`.
   - Если найдено точное совпадение, страница/актив отдаются без дальнейших переписываний.
6. **afterFiles (rewrites) из `next.config.js`**
   - Срабатывают, если предыдущие шаги не нашли совпадения; позволяют дать альтернативный маршрут.
   - Полезно для fallback‑логики к нестатическим маршрутам.
7. **Динамические маршруты (например, `/blog/[slug]`)**
   - Пытаются сопоставить путь с динамическими сегментами.
   - Здесь подключается логика параметров маршрута, ISR/SSR и т.д.
8. **fallback (rewrites) из `next.config.js`**
   - Последняя возможность переписать путь, если ничего не совпало.
   - Используйте аккуратно: слишком широкие правила могут скрыть ошибки 404 и усложнить отладку.

Практические замечания к порядку:
- Чем выше шаг — тем раньше и «дешевле» применяется правило. Старайтесь переносить постоянные редиректы и заголовки в `next.config.js`.
- Middleware держите лёгким: он выполняется до большинства маршрутов и влияет на время до первого байта (TTFB).
- Грамотно настраивайте `matcher`, чтобы исключить служебные пути и избыточные срабатывания.

### Advanced flags
- **skipTrailingSlashRedirect**: отключает авто‑редиректы добавления/удаления хвостового слэша (позволяет реализовать собственные правила в мидлваре).
- **skipMiddlewareUrlNormalize**: отключает нормализацию URL в Next.js (синхронизирует поведение прямых визитов и клиентских переходов, даёт доступ к «сырому» пути).

### Runtime
- **Edge** — по умолчанию: быстрый запуск ближе к пользователю.
- **Node.js** — включается в `config.runtime`, если нужна совместимость с Node‑окружением (напр. нативные модули, больше времени выполнения).

### Тестирование (экспериментально, 15.1+)
- Пакет `next/experimental/testing/server` предоставляет утилиты для unit‑тестов мидлвары.
- Полезные проверки: соответствует ли URL условиям (`unstable_doesMiddlewareMatch`), произошёл ли rewrite/redirect, итоговый URL после переписывания.

### Рекомендации
- Ограничивайте область действия через `config.matcher` (минимизируйте лишние вызовы).
- Держите мидлвару лёгкой: минимум сетевых запросов и вычислений.
- Большие заголовки избегайте (риск ошибки 431).
- Для редиректов можно использовать и `Response.redirect`, но чаще удобнее `NextResponse.redirect`.
